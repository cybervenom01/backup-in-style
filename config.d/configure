#!/bin/bash

###
## Error Handler
#

trap 'err_handle $? $LINENO' ERR

err_handle ()
{
	E_STAT=$1
        LINE_NO=$2
        E_MSG="$( date +%c ): $( uname -n ): ERROR: [$E_STAT] occurred on line $LINE_NO\n"

        printf "%b" "$E_MSG"
        exit $E_STAT
}


###
## Main Configuration File.
###

###
## Variables Configuration
#

ROOT_UID=0
E_UID=1


###
## Check if the configuration file is run as root.
#

if [ "$UID" -ne "$ROOT_UID" ]
then
	printf "\n\n"
	printf "Please run this script with root privileges.\n\n"
	exit $E_UID
fi


###
## Searches for the commands which help to compress, archive, and remotely transfer your data.
#

printf "\nChecking if commands are installed: \n"

A_CMDS=( "tar" "zstd" "ssh" "scp" )

for CMDS in "${A_CMDS[@]}";
do
	printf "$CMDS . . .\n"

        if ! command -v "$CMDS" > /dev/null 2>&1;
        then
                printf "$CMDS not found\n"
                printf "Please install the corresponding packages.\n\n"
                exit 0
        fi
done

printf "Commands are installed.\n"


###
## Copy main script into /usr/local/bin
## Make sure it has the correct file permissions
## and its executable.
#

printf "Copying the script to /usr/local/bin.\n"
cp ../backup-in-style.sh /usr/local/bin/backupstyle

printf "Renaming and changing permissions for script.\n"
chmod 755 /usr/local/bin/backupstyle


###
## Copy the ASCII Art into the /usr/share/backupstyle directory
#

ASCIILOC="/usr/share"
BKDIR="backupstyle"
ASCIIDIR="asciiart"

if [ ! -d ${ASCIILOC}/$BKDIR/$ASCIIDIR ]
then
	printf "Creating bakupstyle directory.\n"
	mkdir -p ${ASCIILOC}/$BKDIR/$ASCIIDIR

	printf "Changing directory permissions."
	chmod 755 ${ASCIILOC}/$BKDIR
	chmod 755 ${ASCIILOC}/$BKDIR/$ASCIIDIR

	printf "Copying ascii art files to the directory.\n"
	cp ../ascii/* ${ASCIILOC}/$BKDIR/$ASCIIDIR

	printf "Changing permissions to the files and directory.\n"
	chmod 644 /usr/share/$BKDIR/$ASCIIDIR/*
else
	printf "iDirectories exists."
fi


###
## Create directory named backupstyle.d in /var/log
#

BKLOGDIR="backupstyle.d"
BKLOGFILE="backupstyle.log"

if [ ! -d $BKLOGDIR ]
then
	printf "Creating $BKLOGDIR directory: \n"
	mkdir /var/log/$BKLOGDIR

	printf "Changing directory permissions for $BKLOGDIR.\n"
	chmod 755 /var/log/$BKLOGDIR
else
	printf "Directory $BKLOGDIR exist."
fi

if [ ! -a /var/log/$BKLOGDIR/$BKLOGFILE ]
then
	printf "Creating $BKLOGFILE log file.\n"
	touch /var/log/$BKLOGDIR/$BKLOGFILE

	printf "Changing file permissions for $BKLOGFILE.\n"
	chmod 644 /var/log/$BKLOGDIR/$BKLOGFILE
else
	printf "Log file $BKLOGFILE exist."
fi


###
## Display message.
#

printf "\nYour backup script is ready.\n"
printf "Keep your data safe and secure.\n\n"

exit 0
